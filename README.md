# Local ECS

https://www.elastic.co/docs/reference/ecs/logging/go-logrus/setup    
https://pkg.go.dev/gopkg.in/go-extras/elogrus.v7@v7.3.0  


## Local Elasticsearch

https://www.elastic.co/docs/deploy-manage/deploy/self-managed/install-elasticsearch-docker-basic#_start_a_single_node_cluster  

```sh
docker network create elastic
```

```sh
docker run -d --name es01 --net elastic -p 9200:9200 -it -m 1GB docker.elastic.co/elasticsearch/elasticsearch:9.2.4
```

```sh
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
```

```sh
docker cp es01:/usr/share/elasticsearch/config/certs/http_ca.crt .
```

```sh
docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
```

```sh
docker run -d --name kib01 --net elastic -p 5601:5601 docker.elastic.co/kibana/kibana:9.2.4
```

## ERROR: Elasticsearch died while starting up, with exit code 78
https://community.sonarsource.com/t/cant-start-docker-container-due-to-elasticsearch-bootstrap-error/132921

I updated etc/sysctl.conf to add this line:

vm.max_map_count=262144

The ran this to update:

sudo sysctl --system

All good after that.

## Test elasticsearch
The default username is `elastic`.  

```sh
ubuntu@ubuntu:~$ docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic
WARNING: Owner of file [/usr/share/elasticsearch/config/users] used to be [root], but now is [elasticsearch]
WARNING: Owner of file [/usr/share/elasticsearch/config/users_roles] used to be [root], but now is [elasticsearch]
This tool will reset the password of the [elastic] user to an autogenerated value.
The password will be printed in the console.
Please confirm that you would like to continue [y/N]y


Password for the [elastic] user successfully reset.
New value: xSdhglJ_4ohN1IpByxtv

ubuntu@ubuntu:~$ curl --cacert http_ca.crt -u elastic:xSdhglJ_4ohN1IpByxtv https://localhost:9200
{
  "name" : "4d5c0267d7ac",
  "cluster_name" : "docker-cluster",
  "cluster_uuid" : "VhXrc330R6aSGeTX_2f5YA",
  "version" : {
    "number" : "9.2.4",
    "build_flavor" : "default",
    "build_type" : "docker",
    "build_hash" : "dfc5c38614c29a598e132c035b66160d3d350894",
    "build_date" : "2026-01-08T22:07:25.170027027Z",
    "build_snapshot" : false,
    "lucene_version" : "10.3.2",
    "minimum_wire_compatibility_version" : "8.19.0",
    "minimum_index_compatibility_version" : "8.0.0"
  },
  "tagline" : "You Know, for Search"
}
```

```sh
ubuntu@ubuntu:~$ docker exec -it es01 /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana
eyJ2ZXIiOiI4LjE0LjAiLCJhZHIiOlsiMTcyLjE4LjAuMjo5MjAwIl0sImZnciI6Ijc4NjZlYWEzOTcyNjk0Y2RmNWNiM2FkMTA2N2E0MDJjZGVlOTNhYmJmYWIzNmU1YmNlZWU5MTFkZjJkYzQ4MzciLCJrZXkiOiJTQmZhdXBzQjNmYjJVSkR2SXpLYTpqNHpKWm01MFRqZXdqUWFBMDB3Sjd3In0=
```

## Kibana Dev Tools

```KQL
# Delete my document
DELETE IndexName/DocType/DocId

# Delete all by index name mylog
POST /mylog/_delete_by_query
{
  "query": {
    "match_all": {}
  }
}
```

## Hiding fields in Summary of Kibana

Try this first, per Data View:  
https://www.elastic.co/docs/explore-analyze/discover/discover-get-started  

This is for global setting:  
To hide the
_id field in Kibana's Discover table, you need to adjust the advanced settings within the UI. 
Steps to Hide the _id Field

    Navigate to Management: From the main Kibana menu, go to Stack Management (or just "Management" in older versions).
    Open Advanced Settings: Under the "Kibana" section, select Advanced Settings.
    Locate the MetaFields setting: Search for the setting named metaFields (or meta:fields in some older versions).
    Edit the list: This setting lists fields that exist outside of the _source and are merged into the document when displayed. The default value typically includes _source, _id, _type, _index, and _score.
    Remove _id: Edit the list and remove _id from the comma-separated values.
    Save Changes: Click the Save or Save changes button to apply the modification. 

After saving, the _id field should no longer appear as a column in the Discover tab's main table view.


## References

https://last9.io/blog/understanding-logrus/  

## Azure ElasticSearch

Example 1:  
```go
package main

import (
	"github.com/olivere/elastic/v7"
	"github.com/sirupsen/logrus"
	"gopkg.in/go-extras/elogrus.v7"
	"context"
)

func main() {
	log := logrus.New()

	// 1. Configure ES Client for Azure
	// Replace with your Azure Elasticsearch URL and API Key
	client, err := elastic.NewClient(
		elastic.SetURL("https://<your-azure-endpoint>.elastic.cloud:9243"), // Example URL
		elastic.SetBasicAuth("elastic", "your-api-key"), // Or other auth methods
		elastic.SetSniff(false), // Often needed for cloud services
		elastic.SetErrorLog(log),
	)
	if err != {
		log.Panic(err)
	}

	// 2. Create the Logrus Hook
	hook, err := elogrus.NewAsyncElasticHook(client, "https://<your-azure-endpoint>", logrus.DebugLevel, "my-azure-app-logs")
	if err != {
		log.Panic(err)
	}

	// 3. Add the hook to the logger
	log.Hooks.Add(hook)

	// 4. Log messages
	log.WithFields(logrus.Fields{"user": "testuser", "action": "login"}).Info("User logged in successfully")
	log.Error("An error occurred during processing")

	// Keep application running briefly to allow logs to send
	// time.Sleep(2 * time.Second)
}
```

Example 2:  
```go
// 1. Import necessary packages
import (
	"github.com/elastic/go-elasticsearch/v8" // Or appropriate v7/v8 client
	"github.com/sirupsen/logrus"
	"gopkg.in/go-extras/elogrus.v8" // Use v8 for newer ES clients
)

func main() {
	log := logrus.New() // Create a new logrus logger

	// 2. Create Elasticsearch Client for Azure
	// Configure with your Azure Elasticsearch endpoint (e.g., https://your-instance.eastus2.azure.elastic.co:9200)
	// You might need to handle authentication (API Key/Basic Auth) here as well.
	esClient, err := elasticsearch.NewClient(elasticsearch.Config{
		Addresses: []string{"https://YOUR_AZURE_ENDPOINT"},
		// Add Auth configs if needed:
		// Username: "elastic",
		// Password: "your_password",
		// APIKey:   "your_api_key",
	})
	if err != nil {
		log.Panicf("Error creating Elasticsearch client: %v", err)
	}

	// 3. Create the Async Elastic Hook
	// Use 'elogrus.NewAsyncElasticHook' for async processing
	// Host parameter is often used for dynamic index naming in some implementations,
	// but the client handles the connection.
	hook, err := elogrus.NewAsyncElasticHook(esClient, "azure-logs", logrus.InfoLevel, "my-azure-index")
	if err != nil {
		log.Panicf("Error creating ElasticHook: %v", err)
	}

	// 4. Add the hook to the logger
	log.Hooks.Add(hook)

	// 5. Log messages (they go to Azure asynchronously)
	log.WithFields(logrus.Fields{"user": "john_doe", "action": "login"}).Info("User logged in successfully")
	log.WithField("error", "connection_failed").Error("Failed to connect to service")
}

```